<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Ruler Example</title>
    
    
    
    
    
    

    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    
    
    
    
<script src="all.js"></script>

<link rel="stylesheet" type="text/css" href="all.css">

</head>
<body>
    <div id="source-code">
        <div id="formula"></div>
        <div id="style"></div>
    </div>
    <div id="help-content" style="display: none;">
        <h2>命令列表</h2>
        <p>具体请查看 <a target="_blank" href="https://github.com/techird/ruler/tree/dev#命令">https://github.com/techird/ruler/tree/dev#命令</a></p>
    </div>
    <a id="help-button">?</a>
    <div id="paper">
        <canvas></canvas>
        <p><a href="https://github.com/techird/ruler" target="_blank">Ruler.js</a> powered by
            <a href="http://techird.com" title="别人笑我太扯淡，我笑他们不扯淡" target="_blank">techird</a>,
            <a href="http://weibo.com/zswang" title="站在巨人的肩上也要成为巨人的一部分" target="_blank">zswang</a>,
            <a href="http://weibo.com/u/1698334494" title="不要叫我大王，要叫我女王大人" target="_blank">Aki_konata</a></p>
    </div>
</body>
<style>
::default {
    path-stroke: #DDD;
}
O, O:hot {
    path-stroke: green;
    path-stroke-width: 3;
}
</style>
<script type="text/javascript">
    /* global CodeMirror: true */

    CodeMirror.defineSimpleMode('ruler', {
        start: [
            {regex: /\/\/.*/, token: "comment" },
            {regex: /(\s*)(def|return)/, token: "keyword" },
            {regex: /(\s*)(\w+)(\s*)(=)(\s*)/, token: [null, 'symbol', null, 'equal'] },
            {regex: /[+-]?\d+(\.?\d+)?/, token: 'number' },
            {regex: /[,|@&~]/, token: 'operator'},
            {regex: /[\(\)\[\]\{\}]/, token: 'parentheses'},
            {regex: /(\s*)([a-zA-Z_$]\w*)(\s*)/, token: [null, 'variable', null]}
        ]
    });

    var sourceEditor = new CodeMirror(document.getElementById('formula'), {
        lineNumbers: true,
        mode: 'ruler',
        value: window.localStorage.rememberSource || '',
        keyMap: 'sublime'
    });

    var styleEditor = new CodeMirror(document.getElementById('style'), {
        lineNumbers: true,
        mode: 'css',
        value: window.localStorage.rememberStyle || '',
        keyMap: 'sublime'
    });

    sourceEditor.setSize('100%', '100%');
    styleEditor.setSize('100%', '100%');

    var canvas = document.querySelector('#paper canvas');
    var ctx = canvas.getContext('2d');
    var ruler = new Ruler(canvas);

    ruler.enableView();
    ruler.enableHover();
    ruler.enableDrag(updateSource);

    function render() {
        var paper = document.getElementById('paper');
        canvas.width = paper.clientWidth;
        canvas.height = paper.clientHeight;
        ruler.render();
    }
    var isUpdatingSource = false;
    function compile() {
        if (isUpdatingSource) return;
        var source = sourceEditor.getValue();
        window.localStorage.rememberSource = source;
        try {
            ruler.parse(source);

            

            updateStyle();
            sourceEditor.eachLine(function(line) {
                sourceEditor.removeLineClass(line, 'wrap', 'error-line');
            });
        } catch (e) {
            if (e.line) {
                sourceEditor.addLineClass(e.line, 'wrap', 'error-line');
            }
            console.warn(e.message, e);
        }
    }

    function updateSource() {
        isUpdatingSource = true;
        sourceEditor.setValue(window.localStorage.rememberSource = ruler.stringify());
        isUpdatingSource = false;
    }

    function updateStyle() {
        var style = styleEditor.getValue();
        ruler.loadStyleSheet(style);
        render();
        window.localStorage.rememberStyle = style;
    }

    compile();

    sourceEditor.on('change', compile);
    styleEditor.on('change', updateStyle);

    window.onresize = render;

    var hbutton = document.getElementById('help-button');

    hbutton.onclick = function() {
        var content = document.getElementById('help-content');
        content.style.display = content.style.display == 'none' ? 'block' : 'none';
        if (content.style.display == 'block') {
            hbutton.classList.add('actived');
        } else {
            hbutton.classList.remove('actived');
        }
    };
</script>
</html>

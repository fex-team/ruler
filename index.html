<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Ruler Example</title>
    <script type="text/javascript" src="src/ruler.js"></script>
    <script type="text/javascript" src="src/steps/base/define_arc.js"></script>
    <script type="text/javascript" src="src/steps/base/define_distance.js"></script>
    <script type="text/javascript" src="src/steps/base/define_line.js"></script>
    <script type="text/javascript" src="src/steps/base/define_point.js"></script>
    <script type="text/javascript" src="src/steps/base/intersect_arc_arc.js"></script>
    <script type="text/javascript" src="src/steps/base/intersect_line_arc.js"></script>
    <script type="text/javascript" src="src/steps/base/intersect_line_line.js"></script>
    <script type="text/javascript" src="src/steps/extend/perpendicular_bisector.js"></script>
    <script type="text/javascript" src="src/steps/extend/bisector.js"></script>
    <script type="text/javascript" src="src/steps/extend/perpendicular_line.js"></script>
    <style type="text/css">
        html, body {
            margin: 0;
            padding: 0;
        }
        canvas {
            display: block;
            position: absolute;
            background: #fefefe;
            right: 0;
            top: 0;
            bottom: 0;
            left: 0;
        }
        #commands {
            width: 300px;
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            box-shadow: 0 0 20px rgba(0,0,0,.3);
            border-left: 1px solid #999;
        }
        #command-input {
            display: block;
            position: absolute;
            border: none;
            padding: 10px;
            box-sizing: border-box;
            position: absolute;
            width: 100%;
            top: 0;
            bottom: 0;
            right: 0;
            left: 0;
            outline: none;
            font-size: 16px;
            resize: none;
            font-family: consolas;
        }
        #paper {
            position: absolute;
            right: 300px;
            top: 0;
            left: 0;
            bottom: 0;
            border-right: 1px solid #ccc;
        }

        #paper p {
            position: absolute;
            right: 10px;
            bottom: 10px;
            margin: 0;
            font-size: 12px;
            color: #ccc;
        }
        .error {
            color: red;
        }
    </style>
</head>
<body>
    <div id="commands">
        <textarea id="command-input" placeholder="Command Here">// 水平辅助线
pd -100 0 x-left&
pd 100 0 x-right&
ld x-left x-right x

// 两个圆是点定义
pd -223 0 A
pd -440 0 A1
pd 230 0 B
pd 140 0 B1

// 取半径
dd A A1 ra
dd B B1 rb

// 定义圆弧
ad A ra Ca!red
ad B rb Cb!blue

// 作公切线
bp A B M //中点
ad2 M A C1
ad A rb C2
lai x C2 0 D
ad3 A A1 D C3
aai C3 C1 0 P
ld A P AP
lai AP Ca 0 Q!red
pl AP Q T!green
lai T Cb 0 F!blue
</textarea>
    </div>
    <div id="paper">
        <canvas></canvas>
        <p>Ruler.js powered by Techird.</p>
    </div>
</body>
<script type="text/javascript">
    var canvas = document.querySelector('#paper canvas');
    var ctx = canvas.getContext('2d');
    var textarea = document.getElementById('command-input');
    var ruler = new Ruler();

    function render() {
        var paper = document.getElementById('paper');
        var width = canvas.width = paper.clientWidth;
        var height = canvas.height = paper.clientHeight;
        ctx.save();
        ctx.translate((width >> 1) + 0.5, (height >> 1) + 0.5);
        ruler.render(ctx, null, -width / 2, width / 2, -height / 2, height / 2);
        ctx.restore();
    }

    function executeAllCommand() {
        var commandLines = textarea.value.split('\n');

        ruler.reset();
        textarea.classList.remove('error');

        try {
            commandLines.forEach(function(command) {
                if (/^\/\//.test(command) || !/\S/.test(command)) return;
                ruler.exec(command.replace(/\s*\/\/.+$/, ''));
            });
            render();
        } catch (e) {
            textarea.classList.add('error');
            /* global console: true */
            console.log(e);
        }

        window.localStorage.rememberCommand = textarea.value;
    }

    var keys = {
        38: 'up',
        40: 'down'
    };
    textarea.onkeydown = function(e) {
        if (!e.altKey || !keys[e.keyCode]) return;

        e.preventDefault();

        var start = textarea.selectionStart,
            end = textarea.selectionEnd,
            length = Math.max(end - start, 1);

        var content = textarea.value;
        var parts = [];

        parts.push(content.substr(0, start));
        parts.push(content.substr(start, length));
        parts.push(content.substr(start + length));

        var number = parseInt(parts[1]);

        if (isNaN(number)) return;

        switch (keys[e.keyCode]) {
            case 'up': number++; break;
            case 'down': number--; break;
        }
        number = number.toString();

        parts[1] = number;

        textarea.value = parts.join('');
        textarea.setSelectionRange(start, start + number.length);

        executeAllCommand();
    };
    
    textarea.value = window.localStorage.rememberCommand || textarea.value;
    executeAllCommand();
    window.onresize = render;
    textarea.oninput = executeAllCommand;

</script>
</html>
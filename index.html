<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Ruler Example</title>
    <script type="text/javascript" src="src/ruler.js"></script>
    <script type="text/javascript" src="src/steps/base/define_arc.js"></script>
    <script type="text/javascript" src="src/steps/base/define_distance.js"></script>
    <script type="text/javascript" src="src/steps/base/define_line.js"></script>
    <script type="text/javascript" src="src/steps/base/define_point.js"></script>
    <script type="text/javascript" src="src/steps/base/intersect_arc_arc.js"></script>
    <script type="text/javascript" src="src/steps/base/intersect_line_arc.js"></script>
    <script type="text/javascript" src="src/steps/base/intersect_line_line.js"></script>
    <script type="text/javascript" src="src/steps/extend/perpendicular_bisector.js"></script>
    <script type="text/javascript" src="src/steps/extend/bisector.js"></script>
    <script type="text/javascript" src="src/steps/extend/perpendicular_line.js"></script>
    <style type="text/css">
        html, body {
            margin: 0;
            padding: 0;
        }
        canvas {
            display: block;
            position: absolute;
            background: #fefefe;
            right: 0;
            top: 0;
            bottom: 0;
            left: 0;
        }
        #commands {
            width: 300px;
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            box-shadow: 0 0 20px rgba(0,0,0,.3);
            border-left: 1px solid #999;
        }
        #command-input {
            display: block;
            position: absolute;
            border: none;
            padding: 10px;
            box-sizing: border-box;
            position: absolute;
            width: 100%;
            top: 0;
            bottom: 0;
            right: 0;
            left: 0;
            outline: none;
            font-size: 16px;
            resize: none;
            font-family: consolas;
        }
        #paper {
            position: absolute;
            right: 300px;
            top: 0;
            left: 0;
            bottom: 0;
            border-right: 1px solid #ccc;
            transform: translate3d(0, 0, 0);
        }
        #paper p {
            position: absolute;
            right: 10px;
            bottom: 10px;
            margin: 0;
            font-size: 12px;
            color: #ccc;
        }
        .error {
            color: red;
        }
        #help-content {
            position: absolute;
            left: 0;
            right: 300px;
            top: 0;
            left: 0;
            bottom: 0;
            transform: translate3d(0, 0, -1);
            z-index: 1;
            background: white;
            padding: 10px 30px;
            border-right: 1px solid #ccc;
            background: #fff;
            font-size: 14px;
        }
        #help-content h2 {
            font-size: 18px;
            font-weight: normal;
            color: #69f;
            margin: 2em 0 1em;
        }
        #help-content table {
            border-collapse: collapse;
            font-family: consolas;
        }
        #help-content td, #help-content th {
            border: 1px solid #EEE;
            padding: 5px 10px;
            text-align: left;
        }
        #help-button {
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 100%;
            background: #69f;
            right: 310px;
            top: 10px;
            z-index: 1;
            cursor: pointer;
            line-height: 26px;
            color: white;
            text-align: center;
            font-family: Arial;
        }
        #help-button:hover {
            background: #7AF;
        }
        #help-button:active, #help-button.actived {
            background: #47d;
        }
    </style>
</head>
<body>
    <div id="commands">
        <textarea id="command-input" placeholder="Command Here">// 水平辅助线
pd -100 0 x-left&
pd 100 0 x-right&
ld x-left x-right x

// 两个圆是点定义
pd -223 0 A
pd -440 0 A1
pd 230 0 B
pd 140 0 B1

// 取半径
dd A A1 ra
dd B B1 rb

// 定义圆弧
ad A ra Ca!red
ad B rb Cb!blue

// 作公切线
bp A B M //中点
ad2 M A C1
ad A rb C2
lai x C2 0 D
ad3 A A1 D C3
aai C3 C1 0 P
ld A P AP
lai AP Ca 0 Q!red
pl AP Q T!green
lai T Cb 0 F!blue
</textarea>
    </div>
    <div id="help-content" style="display: none;">
        <h2>数值控制</h2>
        <p>文本框中光标选中数值后，使用 Alt + Up/Down 可以快速修改数值</p>
        <h2>命令列表</h2>
        <table>
            <thead>
            <tr>
            <th>Command</th>
            <th>Format</th>
            <th>Description</th>
            </tr>
            </thead>
            <tbody>
            <tr>
            <td>define_point</td>
            <td>pd <code>x</code> <code>y</code> <code>p1</code>
            </td>
            <td>定义一个点 p1，点的坐标为 (x, y)</td>
            </tr>
            <tr>
            <td>define_line</td>
            <td>ld <code>p1</code> <code>p2</code> <code>l1</code>
            </td>
            <td>定义一条直线 l1 过点 p1 和点 p2</td>
            </tr>
            <tr>
            <td>define_distance</td>
            <td>dd <code>p1</code> <code>p2</code> <code>d1</code>
            </td>
            <td>定义一段距离 d1 表示点 p1 和点 p2 之间的距离</td>
            </tr>
            <tr>
            <td>define_arc</td>
            <td>ad <code>p1</code> <code>d1</code> <code>a1</code>
            </td>
            <td>定义圆弧 a1 以 p1 为圆心，d1 为半径</td>
            </tr>
            <tr>
            <td>define_arc_2</td>
            <td>ad2 <code>p1</code> <code>p2</code> <code>a1</code>
            </td>
            <td>定义圆弧 a1 以 p1 为圆心，以 p1 到 p2 之间的距离为半径</td>
            </tr>
            <tr>
            <td>define_arc_3</td>
            <td>ad3 <code>p1</code> <code>p2</code> <code>p3</code> <code>a1</code>
            </td>
            <td>定义圆弧 a1 以 p1 为圆心，以 p2 到 p3 之间的距离为半径</td>
            </tr>
            <tr>
            <td>intersect_arc_arc</td>
            <td>aai <code>a1</code> <code>a2</code> <code>index</code> <code>p1</code>
            </td>
            <td>计算圆弧 a1 和 a2 的交点 p1，交点有两个的时候，index 来选择交点（0 或 1）</td>
            </tr>
            <tr>
            <td>intersect_line_arc</td>
            <td>lai <code>l1</code> <code>a1</code> <code>index</code> <code>p1</code>
            </td>
            <td>计算直线 l1 和圆弧 a1 的交点 p1，交点有两个的时候，index 来选择交点（0 或 1）</td>
            </tr>
            <tr>
            <td>intersect_line_line</td>
            <td>lli <code>l1</code> <code>l2</code> <code>p1</code>
            </td>
            <td>计算直线 l1 和圆弧 l2 的交点 p1</td>
            </tr>
            <tr>
            <td>bisector</td>
            <td>bp <code>p1</code> <code>p2</code> <code>m1</code>
            </td>
            <td>定义点 p1 和点 p2 的中点 m1</td>
            </tr>
            <tr>
            <td>perpendicular_bisector</td>
            <td>pbl <code>p1</code> <code>p2</code> <code>l1</code>
            </td>
            <td>定义端点为 p1 和 p2 的线段的垂直平分线</td>
            </tr>
            <tr>
            <td>perpendicular_line</td>
            <td>pl <code>l1</code> <code>p1</code> <code>l2</code>
            </td>
            <td>过点 p1 作直线 l1 的垂线 l2</td>
            </tr>
            </tbody>
        </table>
        <p>具体请查看 <a target="_blank" href="https://github.com/techird/ruler/tree/dev#命令">https://github.com/techird/ruler/tree/dev#命令</a></p>
    </div>
    <a id="help-button">?</a>
    <div id="paper">
        <canvas></canvas>
        <p>Ruler.js powered by Techird.</p>
    </div>
</body>
<script type="text/javascript">
    var canvas = document.querySelector('#paper canvas');
    var ctx = canvas.getContext('2d');
    var textarea = document.getElementById('command-input');
    var ruler = new Ruler();
    function render() {
        var paper = document.getElementById('paper');
        var width = canvas.width = paper.clientWidth;
        var height = canvas.height = paper.clientHeight;
        ctx.save();
        ctx.translate((width >> 1) + 0.5, (height >> 1) + 0.5);
        ruler.render(ctx, null, -width / 2, width / 2, -height / 2, height / 2);
        ctx.restore();
    }
    function executeAllCommand() {
        var commandLines = textarea.value.split('\n');
        ruler.reset();
        textarea.classList.remove('error');
        try {
            commandLines.forEach(function(command) {
                if (/^\/\//.test(command) || !/\S/.test(command)) return;
                ruler.exec(command.replace(/\s*\/\/.+$/, ''));
            });
            render();
        } catch (e) {
            textarea.classList.add('error');
            /* global console: true */
            console.log(e);
        }
        window.localStorage.rememberCommand = textarea.value;
    }
    var keys = {
        38: 'up',
        40: 'down'
    };
    textarea.onkeydown = function(e) {
        if (!e.altKey || !keys[e.keyCode]) return;
        e.preventDefault();
        var start = textarea.selectionStart,
            end = textarea.selectionEnd,
            length = Math.max(end - start, 1);
        var content = textarea.value;
        var parts = [];
        parts.push(content.substr(0, start));
        parts.push(content.substr(start, length));
        parts.push(content.substr(start + length));
        var number = parseInt(parts[1]);
        if (isNaN(number)) return;
        switch (keys[e.keyCode]) {
            case 'up': number++; break;
            case 'down': number--; break;
        }
        number = number.toString();
        parts[1] = number;
        textarea.value = parts.join('');
        textarea.setSelectionRange(start, start + number.length);
        executeAllCommand();
    };

    textarea.value = window.localStorage.rememberCommand || textarea.value;
    executeAllCommand();
    window.onresize = render;
    textarea.oninput = executeAllCommand;
    var hbutton = document.getElementById('help-button');
    hbutton.onclick = function() {
        var content = document.getElementById('help-content');
        content.style.display = content.style.display == 'none' ? 'block' : 'none';
        if (content.style.display == 'block') {
            hbutton.classList.add('actived');
        } else {
            hbutton.classList.remove('actived');
        }
    };
</script>
</html>
